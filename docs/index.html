<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Guide | StateM</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/statem/assets/css/0.styles.9cb8d412.css" as="style"><link rel="preload" href="/statem/assets/js/app.1541a6dc.js" as="script"><link rel="preload" href="/statem/assets/js/10.4156a89d.js" as="script"><link rel="preload" href="/statem/assets/js/4.05f9ac7f.js" as="script"><link rel="prefetch" href="/statem/assets/js/2.3db63443.js"><link rel="prefetch" href="/statem/assets/js/3.65331650.js"><link rel="prefetch" href="/statem/assets/js/5.8a56bff4.js"><link rel="prefetch" href="/statem/assets/js/6.0cf06eb2.js"><link rel="prefetch" href="/statem/assets/js/7.62b7b24f.js"><link rel="prefetch" href="/statem/assets/js/8.37427b46.js"><link rel="prefetch" href="/statem/assets/js/9.281a86d3.js">
    <link rel="stylesheet" href="/statem/assets/css/0.styles.9cb8d412.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/statem/" class="home-link router-link-exact-active router-link-active"><!----> <span class="site-name">StateM</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/venkatperi/statem" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/venkatperi/statem" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/statem/" class="active sidebar-link">Guide</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/statem/#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/statem/#features" class="sidebar-link">Features</a></li><li class="sidebar-sub-header"><a href="/statem/#installation" class="sidebar-link">Installation</a></li><li class="sidebar-sub-header"><a href="/statem/#usage" class="sidebar-link">Usage</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/statem/#subclassing-statemachine" class="sidebar-link">Subclassing StateMachine</a></li><li class="sidebar-sub-header"><a href="/statem/#in-the-browser" class="sidebar-link">In the Browser</a></li><li class="sidebar-sub-header"><a href="/statem/#react-state-management" class="sidebar-link">React State Management</a></li></ul></li><li class="sidebar-sub-header"><a href="/statem/#how-it-works" class="sidebar-link">How It Works</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/statem/#routes" class="sidebar-link">Routes</a></li><li class="sidebar-sub-header"><a href="/statem/#event-handlers" class="sidebar-link">Event Handlers</a></li><li class="sidebar-sub-header"><a href="/statem/#result-builder" class="sidebar-link">Result Builder</a></li><li class="sidebar-sub-header"><a href="/statem/#mutating-state-machine-data" class="sidebar-link">Mutating State Machine Data</a></li><li class="sidebar-sub-header"><a href="/statem/#event-types" class="sidebar-link">Event Types</a></li><li class="sidebar-sub-header"><a href="/statem/#processing-events" class="sidebar-link">Processing Events</a></li></ul></li></ul></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Examples</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p><strong>statem</strong> is a JavaScript state/turing machine framework which lets you manage your application's <em>total state</em> (i.e. named states, transitions, data, and rewriting of inputs).</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>StateM is largely based on Erlang OTP’s <a href="http://erlang.org/doc/design_principles/statem.html" title="gen_statem" target="_blank" rel="noopener noreferrer">gen_statem<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> behavior.</p></div> <h4 id="event-driven"><a href="#event-driven" class="header-anchor">#</a> Event Driven</h4> <p><em>StateM</em> is an event-driven state machine where the input is an event that triggers a state transition and the output is actions executed during the state transition. Events drive the state machine and are externally triggered or internally generated by the state machine. Pending events are tracked on a priority queue that preserves entry order.</p> <h4 id="handlers"><a href="#handlers" class="header-anchor">#</a> Handlers</h4> <p>State machines are specified as an ordered list of handlers keyed on <code>Event x State</code> tuples (wildcards and patterns are allowed to combine handlers).</p> <h4 id="handling-events"><a href="#handling-events" class="header-anchor">#</a> Handling Events</h4> <p>If the state machine is in state <code>S</code> and event <code>E</code> occurs, the state machine will perform actions <code>A</code> and make a transition to state <code>S'</code>(<code>S'</code> can be equal to <code>S</code> and <code>A</code> can be empty).</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">State</span><span class="token punctuation">(</span><span class="token constant">S</span><span class="token punctuation">)</span> x <span class="token function">Event</span><span class="token punctuation">(</span><span class="token constant">E</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">Actions</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">State</span><span class="token punctuation">(</span><span class="token constant">S</span>'<span class="token punctuation">)</span>
</code></pre></div><p>To do this, statem will match the tuple <code>ExS</code> against the keys of the ordered list of handlers for the first matching handler, execute its actions <code>A</code> and transition to the</p> <h4 id="arbitrary-data"><a href="#arbitrary-data" class="header-anchor">#</a> Arbitrary Data</h4> <p>State machines can hold arbitrary data which is provided to, and can be mutated by, it's event handlers.</p> <h4 id="total-state"><a href="#total-state" class="header-anchor">#</a> Total State</h4> <p><em>Statem</em> provides management of <em>total state</em>, i.e.:</p> <ul><li>Management of states and transitions as in a DFA,</li> <li>Custom read/write memory available to handlers,</li> <li>Ability to rewrite inputs by postponing them.</li></ul> <h2 id="features"><a href="#features" class="header-anchor">#</a> Features</h2> <ul><li><strong>Co-located code</strong>: Event, states, transitions and actions in one place.</li> <li><strong>Inserted Events</strong>: Insert events from within the specification.</li> <li><strong>State Entry Events</strong>: Automatically generates Entry events on state change.</li> <li><strong>Timeouts</strong>: Install timeouts for state transitions, new events, or just plain timeouts.</li></ul> <h2 id="installation"><a href="#installation" class="header-anchor">#</a> Installation</h2> <p>Install with <code>npm</code>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> --save gen-statem
</code></pre></div><h2 id="usage"><a href="#usage" class="header-anchor">#</a> Usage</h2> <p>Create a state machine by calling <code>StateMachine's</code> constructor and passing it a list of handlers, the initial state and optional data.</p> <div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>The state machine’s data type <code>TData</code> is a type argument (<code>StateMachine&lt;TData&gt;</code>).</p></div> <p>For example, the state machine below toggles states <code>ONE</code> and <code>TWO</code> on event <code>next</code>. <img src="https://documents.lucidchart.com/documents/eef39cb2-9656-4c52-88d8-eb6c9f6a5cec/pages/YGcM5DNywbTK?a=1152&amp;x=85&amp;y=151&amp;w=360&amp;h=181&amp;store=1&amp;accept=image/*&amp;auth=LCA%20a77efaa9c861072b1008c96fd065a7b008f5aa33-ts=1538363749" alt=""></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">let</span> sm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StateMachine</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    handlers<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span><span class="token string">'cast#next#ONE'</span><span class="token punctuation">,</span> <span class="token string">'TWO'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">'cast#next#TWO'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">nextState</span><span class="token punctuation">(</span><span class="token string">'ONE'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
    initialState<span class="token punctuation">:</span> <span class="token string">&quot;ONE&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
sm<span class="token punctuation">.</span><span class="token function">startSM</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
sm<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'stateChanged'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> old<span class="token punctuation">,</span> data<span class="token punctuation">,</span> event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>old<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> --&gt; </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> on </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event <span class="token operator">?</span> event<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

sm<span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">'next'</span><span class="token punctuation">)</span> <span class="token comment">// ONE --&gt; TWO on Cast@Low { context: 'next' }</span>
sm<span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">'next'</span><span class="token punctuation">)</span> <span class="token comment">// TWO --&gt; ONE on Cast@Low { context: 'next' }</span>
</code></pre></div><h3 id="subclassing-statemachine"><a href="#subclassing-statemachine" class="header-anchor">#</a> Subclassing StateMachine</h3> <p>Extending the <code>StateMachine</code> class lets you declare and implement a public API for your state machine (and wrap call/cast dispatch calls).</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Handler functions are called with <code>this</code> set to the state machine instance.</p></div> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">PingPong</span> <span class="token keyword">extends</span> <span class="token class-name">StateMachine</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    handlers<span class="token punctuation">:</span> Handlers<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span><span class="token string">'cast#next#ONE'</span><span class="token punctuation">,</span> <span class="token string">'TWO'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">'cast#next#TWO'</span><span class="token punctuation">,</span> <span class="token string">'ONE'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>
    initialState <span class="token operator">=</span> <span class="token string">&quot;ONE&quot;</span>
    <span class="token comment">// Define our public API</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">'next'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> sm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PingPong</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
sm<span class="token punctuation">.</span><span class="token function">startSM</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
sm<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'stateChanged'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> old<span class="token punctuation">,</span> data<span class="token punctuation">,</span> event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>old<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> --&gt; </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> on </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event <span class="token operator">?</span> event<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

sm<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// ONE --&gt; TWO on Cast@Low { context: 'next' }</span>
sm<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// TWO --&gt; ONE on Cast@Low { context: 'next' }</span>
</code></pre></div><h3 id="in-the-browser"><a href="#in-the-browser" class="header-anchor">#</a> In the Browser</h3> <p>Fetch it from npm via unpkg:</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>https://unpkg.com/gen-statem/dist/umd/gen-statem.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="react-state-management"><a href="#react-state-management" class="header-anchor">#</a> React State Management</h3> <p>StateM accepts a <code>DataProxy</code> object to synchronize its internal data with external objects such as React components.</p> <blockquote><p>Terminology: State machine data == React component state</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StateMachine</span><span class="token punctuation">(</span> <span class="token punctuation">{</span>
      dataProxy<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span>
        <span class="token function-variable function">set</span><span class="token punctuation">:</span> <span class="token punctuation">(</span> <span class="token parameter">data<span class="token punctuation">,</span> state</span> <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token operator">...</span>data<span class="token punctuation">,</span> currentState<span class="token punctuation">:</span> state <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="how-it-works"><a href="#how-it-works" class="header-anchor">#</a> How It Works</h2> <h3 id="routes"><a href="#routes" class="header-anchor">#</a> Routes</h3> <p>StateM uses the url path to parameterized route matching seen in <a href="www.expressjs.com">express</a> et. al.</p> <h4 id="current-event-routes"><a href="#current-event-routes" class="header-anchor">#</a> Current Event Routes</h4> <p>The current event and current state are mapped to a route string as:</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;current event&gt;#&lt;event context&gt;#&lt;current state&gt;
</code></pre></div><p>For example:</p> <table><thead><tr><th>Event</th> <th>Event Context</th> <th>Current State</th> <th>Route</th></tr></thead> <tbody><tr><td>cast</td> <td><code>&quot;flip&quot;</code></td> <td>off</td> <td><code>&quot;cast#flip#off&quot;</code></td></tr> <tr><td>cast</td> <td><code>{button: 2}</code></td> <td>locked</td> <td><code>&quot;cast#button/2#off&quot;</code></td></tr> <tr><td>call</td> <td><code>&quot;getInfo&quot;</code></td> <td>one</td> <td><code>&quot;call/internalId#getInfo/2#one&quot;</code></td></tr></tbody></table> <h4 id="event-handler-routes"><a href="#event-handler-routes" class="header-anchor">#</a> Event Handler Routes</h4> <p>In addition to string literals, handler routes can include:</p> <ul><li>Parameter capture patterns (<code>:param</code>) capture up to the next <code>/</code>, <code>#</code> or the end of the route.</li> <li>Splats (<code>*param</code>) capture from up to <code>#</code> or the end of the route.</li> <li>Parts of the route can be marked optional by wrapping in parenthesis. Optional parts can include parameter capture and splats.</li></ul> <h5 id="examples"><a href="#examples" class="header-anchor">#</a> Examples</h5> <ul><li><code>cast#flip#:state</code> will match a <code>cast(flip)</code> event in any state and provide the current state as an argument (<code>args.param</code>) to the handler.</li> <li><code>call/:from#getInfo#:state</code> will capture the callerId and state as <code>args.from</code> and <code>args.state</code> respectively.</li> <li><code>&quot;cast#button/:digit#locked</code> will capture a button press in the <code>locked</code> state and provide the digit value in <code>args.digit</code>.</li> <li><code>&quot;cast#*context#open</code> intercepts any <code>cast</code> events in state <code>open</code> regardless of the parameters passed when cast was invoked (note: the splat will be available as <code>args.context</code>).</li></ul> <h3 id="event-handlers"><a href="#event-handlers" class="header-anchor">#</a> Event Handlers</h3> <p>A key part of a state machine specification is the list of (route, handler) tuples:</p> <div class="language- extra-class"><pre class="language-text"><code>(string | Array&lt;string&gt;, function | string | [string, string | number])
</code></pre></div><blockquote><p>Note: Event handlers are specified as an array to preserve order (vs. objects, where property<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/for...in#Deleted_added_or_modified_properties" target="_blank" rel="noopener noreferrer">iteration order<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is arbitrary).</p></blockquote> <h4 id="multiple-routes-to-a-handler"><a href="#multiple-routes-to-a-handler" class="header-anchor">#</a> Multiple Routes to a Handler</h4> <p>When a route is specified as an array, it is treated as a boolean OR, i.e. if any route matches an incoming event route, the corresponding handler is invoked.</p> <h4 id="handler-functions"><a href="#handler-functions" class="header-anchor">#</a> Handler Functions</h4> <p>Handler functions receive the following:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">type</span> HandlerOpts<span class="token operator">&lt;</span>TData<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    args<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>k <span class="token keyword">in</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    current<span class="token punctuation">:</span> State<span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> TData<span class="token punctuation">,</span>
    event<span class="token punctuation">:</span> Event<span class="token punctuation">,</span>
    route<span class="token punctuation">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>current</code>: the state machine’s current state.</li> <li><code>data</code>: the state machine’s current data.</li> <li><code>args</code>: any arguments or splats parsed from the incoming event’s route.</li> <li><code>event</code>: the actual incoming event.</li> <li><code>route</code>: the event’s route.</li></ul> <p>Handler functions can return:</p> <ul><li><code>ResultBuilder</code> a fluent builder for <code>Results</code>.</li> <li><code>Result</code> - verbose, not recommended.</li> <li><code>void</code> - interpreted as <code>keepStateAndData</code></li></ul> <h4 id="string-handlers"><a href="#string-handlers" class="header-anchor">#</a> <code>string</code> Handlers</h4> <p>Instead of a handler function, you can provide a</p> <ul><li><code>state: string</code> - interpreted as a next state directive.</li> <li><code>[state: string, timeout: string | number]</code> - interpreted as a next state directive and event timeout.</li></ul> <h3 id="result-builder"><a href="#result-builder" class="header-anchor">#</a> Result Builder</h3> <p>StateM provides a fluent interface (<code>ResultBuilder</code>) for specifying state transitions and actions in handler functions.</p> <p>The following functions return a <code>ResultBuilder</code>:</p> <ul><li><a href="#">keepState</a>: Instructs the state machine to keep the current state (i.e. transition to the same state). Does not emit a state entry event.</li> <li><a href="#">repeatState</a>: Like <code>keepState</code>, but emits a state entry event.</li> <li><a href="#">nextState(state)</a>: Instructs the state machine to transition to the given <code>state</code> (can be the current state).</li></ul> <h4 id="resultbuilder-methods"><a href="#resultbuilder-methods" class="header-anchor">#</a> ResultBuilder Methods</h4> <p><code>ResultBuilders</code> provide the following chainable methods:</p> <ul><li><a href="#">data(spec)</a>: Instructs the state machine to mutate state data with the given <code>spec</code>.</li> <li><a href="#">eventTimeout(time)</a>: Starts the event timer which may result in a <code>EventTimeoutEvent</code> event if a new event is not received.</li> <li><a href="#">stateTimeout(time)</a>: Starts the state timer which may result in a <code>StateTimeoutEvent</code> event if a state transition does not occur.</li> <li><a href="#">timeout(time, name)</a>: Starts a generic timer with an optional name which may result in a <code>GenericTimeoutEvent</code>. Calling <code>timeout(name)</code> will cancel the event if it has not yet fired.</li> <li><a href="#">nextEvent(type, context, extra)</a>: Inserts an event of the given type at the front of the queue so that it is executed before pending events.</li> <li><a href="#">internalEvent(context, extra)</a>: Like <code>nextEvent</code>, this method inserts an <code>InternalEvent</code> event.</li> <li><a href="#">postpone</a>: Instructs the state machine to postpone the current until the state changes at which point any postponed events are delivered before pending events.</li> <li><a href="#">reply(from, msg)</a>: Instructs the state machine to reply to the sender with id <code>from</code>; the result of a prior invocation of <code>call</code>.</li></ul> <h3 id="mutating-state-machine-data"><a href="#mutating-state-machine-data" class="header-anchor">#</a> Mutating State Machine Data</h3> <p>State machine data is mutated by calling the <code>data</code> on <code>ResultBuilder</code> with <a href="#">immutability-helper</a> commands, including:</p> <ul><li><code>{$push: array}</code> <code>push()</code> all the items in <code>array</code> on the target.
<ul><li><code>{$unshift: array}</code> <code>unshift()</code> all the items in <code>array</code> on the target.</li> <li><code>{$splice: array of arrays}</code> for each item in <code>arrays</code> call <code>splice()</code> on the target with the parameters provided by the item. Note: The items in the array are applied sequentially, so the order matters. The indices of the target may change during the operation.* * <code>{$set: any}</code> replace the target entirely.</li> <li><code>{$toggle: array of strings}</code> toggles a list of boolean fields from the target object.</li> <li><code>{$unset: array of strings}</code> remove the list of keys in <code>array</code> from the target object.</li> <li><code>{$merge: object}</code> merge the keys of <code>object</code> with the target.</li> <li><code>{$apply: function}</code> passes in the current value to the function and updates it with the new returned value.</li> <li><code>{$add: array of objects}</code> add a value to a <code>Map</code> or <code>Set</code>. When adding to a <code>Set</code> you pass in an array of objects to add, when adding to a Map, you pass in <code>[key, value]</code> arrays like so: <code>update(myMap, {$add: [['foo', 'bar'], ['baz', 'boo']]})</code></li> <li><code>{$remove: array of strings}</code> remove the list of keys in array from a <code>Map</code> or <code>Set</code>.</li></ul></li></ul> <h3 id="event-types"><a href="#event-types" class="header-anchor">#</a> Event Types</h3> <h4 id="callevent"><a href="#callevent" class="header-anchor">#</a> CallEvent</h4> <p>Sends a event of type <code>call</code> to the state machine and returns a pending Promise.
*   Call <code>call(context, extra)</code> to emit.
*   Event handlers can reply with <code>reply()</code> action which resolves the pending Promise returned by <code>call()</code>.
*   Internally, call generates a <code>from</code> id to identify the caller.
*   The event route for call is: <code>call/&lt;from&gt;#&lt;context&gt;#&lt;state&gt;</code>.</p> <h4 id="castevent"><a href="#castevent" class="header-anchor">#</a> CastEvent</h4> <p>Sends a event of type <code>cast</code> to the state machine and returns without waiting for a result.
*   Call <code>cast(context, extra)</code> to emit.
*   The event route for cast is: <code>cast#&lt;context&gt;#&lt;state&gt;</code>.</p> <h4 id="enterevent"><a href="#enterevent" class="header-anchor">#</a> EnterEvent</h4> <p>Sends a <code>enter</code> event to the state machine.
*   Internally generated by the state machine on a state transition. If the state machine is transitioning to the same state, <code>enter</code> is emitted if the previous event handler returns <code>repeatState</code> (and not for either of <code>keepState</code>, or <code>nextState(same state)</code>).</p> <h4 id="eventtimeoutevent"><a href="#eventtimeoutevent" class="header-anchor">#</a> EventTimeoutEvent</h4> <p>Sends a <code>eventTimeout</code> event to the state machine.
*   Internally generated by the state machine when the eventTimeout timer fires.
*   The eventTimeout timer is started by invoking <code>eventTimeout(timeout)</code> in a event handler.
*   The event route for <code>eventTimeout</code> is: <code>eventTimeout#&lt;context&gt;#&lt;state&gt;</code>.
*   Can be cancelled by calling <code>eventTimeout()</code> without a timeout argument from an event handler.</p> <h4 id="generictimeoutevent"><a href="#generictimeoutevent" class="header-anchor">#</a> GenericTimeoutEvent</h4> <p>Sends a <code>genericTimeout</code> event to the state machine.
*   Internally generated by the state machine when the (optionally named) genericTimeout timer fires.
*   A genericTimeout timer is started by invoking <code>genericTimeout(timeout [, name])</code> in a event handler.
*   The event route for <code>genericTimeout</code> is: <code>genericTimeout#&lt;context&gt;#&lt;state&gt;</code>.
*   Can be cancelled by calling <code>genericTimeout([name])</code> without a timeout argument from an event handler.</p> <h4 id="statetimeoutevent"><a href="#statetimeoutevent" class="header-anchor">#</a> StateTimeoutEvent</h4> <p>Sends a <code>stateTimeout</code> event to the state machine.
*   Internally generated by the state machine when the stateTimeout timer fires.
*   The stateTimeout timer is started by invoking <code>stateTimeout(timeout)</code> in a event handler.
*   The event route for <code>stateTimeout</code> is: <code>stateTimeout#&lt;context&gt;#&lt;state&gt;</code>.
*   Can be cancelled by calling <code>stateTimeout()</code> without arguments from an event handler.</p> <h4 id="internalevent"><a href="#internalevent" class="header-anchor">#</a> InternalEvent</h4> <p>Sends a <code>internal</code> event to the state machine. This is a deliberately named event to let the state machine know that the event is internal.
*   Internally generated by invoking <code>internal(context, extra)</code> from a event handler.
*   The event route for <code>internal</code> is: <code>internal#&lt;context&gt;#&lt;state&gt;</code>.</p> <h3 id="processing-events"><a href="#processing-events" class="header-anchor">#</a> Processing Events</h3> <p>The state machine looks for the first event handler whose key matches the <code>incoming event x current state</code>, or, a catch-all handler.</p> <p>The matched handler is invoked with the incoming event, route matching arguments, the current state machine state and data.</p> <p>The result of the handler invocation can include a state transition directive and transition actions, which are immediately executed, potentially changing the state machine’s state, mutating the internal data as well as the event queue.</p> <div class="language- extra-class"><pre class="language-text"><code></code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/statem/demo/hotelsafe.html">A Hotel Safe</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/statem/assets/js/app.1541a6dc.js" defer></script><script src="/statem/assets/js/10.4156a89d.js" defer></script><script src="/statem/assets/js/4.05f9ac7f.js" defer></script>
  </body>
</html>
